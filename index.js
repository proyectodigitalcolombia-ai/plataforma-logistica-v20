const express=require('express'),{Sequelize,DataTypes}=require('sequelize'),app=express();
app.use(express.urlencoded({extended:true}));app.use(express.json());
const db=new Sequelize(process.env.DATABASE_URL,{dialect:'postgres',logging:false,dialectOptions:{ssl:{require:true,rejectUnauthorized:false}}});
const C=db.define('Carga',{oficina:DataTypes.STRING,emp_gen:DataTypes.STRING,comercial:DataTypes.STRING,pto:DataTypes.STRING,refleja:DataTypes.STRING,f_doc:DataTypes.STRING,h_doc:DataTypes.STRING,do_bl:DataTypes.STRING,cli:DataTypes.STRING,subc:DataTypes.STRING,mod:DataTypes.STRING,lcl:DataTypes.STRING,cont:DataTypes.STRING,peso:DataTypes.STRING,unid:DataTypes.STRING,prod:DataTypes.STRING,esq:DataTypes.STRING,vence:DataTypes.STRING,orig:DataTypes.STRING,dest:DataTypes.STRING,t_v:DataTypes.STRING,ped:DataTypes.STRING,f_c:DataTypes.STRING,h_c:DataTypes.STRING,f_d:DataTypes.STRING,h_d:DataTypes.STRING,placa:DataTypes.STRING,f_p:DataTypes.STRING,f_f:DataTypes.STRING,obs_e:{type:DataTypes.STRING,defaultValue:'PENDIENTE INSTRUCCIONES'},f_act:DataTypes.STRING,obs:DataTypes.TEXT,cond:DataTypes.TEXT,h_t:DataTypes.STRING,muc:DataTypes.STRING,desp:DataTypes.STRING,f_fin:DataTypes.STRING,est_real:{type:DataTypes.STRING,defaultValue:'PENDIENTE'}},{timestamps:true});
const opts={oficina:['CARTAGENA','BOGOT√Å','BUENAVENTURA','MEDELL√çN'],puertos:['SPIA','SPRB','TCBUEN','CONTECAR','SPRC','PUERTO COMPAS','PUERTO BAH√çA','AGUADULCE','ESENTTIA','YARA','N/A'],clientes:['GEODIS','MAERSK','SAMSUNG','ENVAECOL','SEA CARGO','YARA','ESENTTIA','BRINSA','PAZ DEL RIO','TERNIUM','PLASTICOS','MAYAGUEZ','TENARIS','LUKER','CORONA','NOMOS','POLAR','PLEXA','FAJOBE'],modalidades:['NACIONALIZADO','OTM','DTA','TRASLADO','EXP','ITR','VACIO'],lcl_fcl:['SUELTA','CONT 40','CONT 20','REF 40','REF 20'],esquemas:['1 ESC-SELLO','2 ESC-SELLO','SELLO','NO REQ','INSPECTORES'],vehiculos:['TURBO','SENCILLO','PATINETA','MULA 2S3','MULA 3S2','MULA 3S3','CAMA BAJA','D.TROQUE'],ciudades:['BOGOT√Å','MEDELL√çN','CALI','BARRANQUILLA','CARTAGENA','BUENAVENTURA','S.MARTA','C√öCUTA','PEREIRA','VILLAVO','SIBERIA','FUNZA','MOSQUERA'],subc:['HIKVISION','PAYLESS','DONSSON','SAMSUNG','EXITO','ALKOSTO','FALABELLA','SODIMAC','ALPLA','AMCOR','MEXICHEM','D1','J.MARTINS'],estados:['ASIGNADO','PEND CITA','CON CITA','CANCELADO','INSPECCION','RETIRADO ITR','DESPACHADO','EN RUTA','PEND PATIO','PRE ASIGNADO','FINALIZADO'],desp:['ABNNER M','CAMILO T','FREDY C','RAUL L','EDDIER R']};
const getNow=()=>new Date().toLocaleString('es-CO',{timeZone:'America/Bogota',hour12:false});
const css=`<style>body{background:#0f172a;color:#fff;font-family:sans-serif;margin:0;padding:20px}.sc{width:100%;overflow-x:auto;background:#1e293b;border:1px solid #334155;border-radius:8px}.fs{height:12px;margin-bottom:5px}.fc{width:8500px;height:1px}table{border-collapse:collapse;min-width:8500px;font-size:10px}th{background:#1e40af;padding:12px;position:sticky;top:0;border-right:1px solid #3b82f6}td{padding:8px;border:1px solid #334155;text-align:center}.form{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:20px;background:#1e293b;padding:15px;border-radius:8px;border:1px solid #2563eb}.fg{display:flex;flex-direction:column;gap:2px}label{font-size:9px;color:#94a3b8;font-weight:700}input,select,textarea{padding:6px;border-radius:4px;border:none;font-size:11px}#busq{padding:10px;width:250px;border-radius:6px;background:#1e293b;color:#fff;border:1px solid #3b82f6}.vence-rojo{background:#dc2626!important;font-weight:bold;animation:blink 2s infinite;cursor:pointer}.vence-amar{background:#fbbf24!important;color:#000!important;font-weight:bold}.st-desp{background:#065f46;color:#34d399;padding:4px 8px;border-radius:12px}@keyframes blink{0%{opacity:1}50%{opacity:0.6}100%{opacity:1}}</style>`;
app.get('/',async(req,res)=>{try{const d=await C.findAll({order:[['id','DESC']]});let rows='';const hoy=new Date();hoy.setHours(0,0,0,0);for(let c of d){const isL=c.f_fin?'disabled':'';let vs='';if(c.vence&&!c.f_fin){const dv=new Date(c.vence),df=Math.ceil((dv-hoy)/(864e5));if(df<=2)vs='vence-rojo';else if(df<=6)vs='vence-amar'}let sto='';opts.estados.forEach(s=>{sto+=`<option value="${s}" ${c.obs_e===s?'selected':''}>${s}</option>`});rows+=`<tr><td>${c.id}</td><td>${new Date(c.createdAt).toLocaleString()}</td><td>${c.oficina||''}</td><td>${c.emp_gen||''}</td><td>${c.comercial||''}</td><td>${c.pto||''}</td><td>${c.refleja||''}</td><td>${c.f_doc||''}</td><td>${c.h_doc||''}</td><td>${c.do_bl||''}</td><td>${c.cli||''}</td><td>${c.subc||''}</td><td>${c.mod||''}</td><td>${c.lcl||''}</td><td>${c.cont||''}</td><td>${c.peso||''}</td><td>${c.unid||''}</td><td>${c.prod||''}</td><td>${c.esq||''}</td><td class="${vs}" onclick="silenciar(this)">${c.vence||''}</td><td>${c.orig||''}</td><td>${c.dest||''}</td><td>${c.t_v||''}</td><td>${c.ped||''}</td><td>${c.f_c||''}</td><td>${c.h_c||''}</td><td>${c.f_d||''}</td><td>${c.h_d||''}</td><td><form action="/u/${c.id}" method="POST" style="margin:0;display:flex"><input name="placa" value="${c.placa||''}" ${isL} style="width:60px"><button ${isL}>OK</button></form></td><td>${c.f_p||''}</td><td>${c.f_f||''}</td><td><select onchange="updS(${c.id},this.value)" ${isL}>${sto}</select></td><td>${c.f_act||''}</td><td><span class="${c.est_real==='DESPACHADO'?'st-desp':''}">${c.est_real}</span></td><td style="min-width:200px">${c.obs||''}</td><td>${c.f_fin?`FIN: ${c.f_fin}`:(c.placa?`<a href="/f/${c.id}" onclick="return confirm('¬øFin?')">üèÅ FIN</a>`:'-')}</td><td><a href="/d/${c.id}" onclick="return confirm('¬øBorrar?')">DEL</a></td></tr>`}res.send(`<html><head><meta charset="UTF-8"><title>LOGISV20</title>${css}</head><body onclick="actA()"><h2 style="color:#3b82f6">CONTROL V20</h2><div style="display:flex;gap:10px;margin-bottom:15px"><input id="busq" onkeyup="buscar()" placeholder="üîç Buscar..."></div><form action="/add" method="POST" class="form"><div class="fg"><label>Oficina</label><select name="oficina">${opts.oficina.map(o=>`<option value="${o}">${o}</option>`).join('')}</select></div><div class="fg"><label>Puerto</label><select name="pto">${opts.puertos.map(o=>`<option value="${o}">${o}</option>`).join('')}</select></div><div class="fg"><label>DO/BL</label><input name="do_bl"></div><div class="fg"><label>Cliente</label><select name="cli">${opts.clientes.map(o=>`<option value="${o}">${o}</option>`).join('')}</select></div><div class="fg"><label>Contenedor</label><input name="cont"></div><div class="fg"><label>Vence</label><input name="vence" type="date"></div><div class="fg"><label>Despacho</label><select name="desp">${opts.desp.map(o=>`<option value="${o}">${o}</option>`).join('')}</select></div><button style="grid-column:1/-1;background:#2563eb;color:#fff;padding:10px;font-weight:bold">GUARDAR</button></form><div class="sc fs" id="st"><div class="fc"></div></div><div class="sc" id="sm"><table id="tab"><thead><tr><th>ID</th><th>REGISTRO</th><th>OFICINA</th><th>EMP</th><th>COM</th><th>PTO</th><th>REF</th><th>F.DOC</th><th>H.DOC</th><th>DO/BL</th><th>CLI</th><th>SUB</th><th>MOD</th><th>LCL</th><th>CONT</th><th>PESO</th><th>UNID</th><th>PROD</th><th>ESQ</th><th>VENCE</th><th>ORIG</th><th>DEST</th><th>VEH</th><th>PED</th><th>F.C</th><th>H.C</th><th>F.D</th><th>H.D</th><th>PLACA</th><th>PAGAR</th><th>FACT</th><th>ESTADO</th><th>ACTU</th><th>REAL</th><th>OBS</th><th>FIN</th><th>DEL</th></tr></thead><tbody>${rows}</tbody></table></div><script>const t=document.getElementById('st'),m=document.getElementById('sm');t.onscroll=()=>m.scrollLeft=t.scrollLeft;m.onscroll=()=>t.scrollLeft=m.scrollLeft;function updS(id,v){fetch('/s/'+id,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({obs_e:v})}).then(r=>r.ok&&location.reload())}function buscar(){let f=document.getElementById("busq").value.toUpperCase(),rs=document.getElementById("tab").rows;for(let i=1;i<rs.length;i++)rs[i].style.display=rs[i].innerText.toUpperCase().includes(f)?"":"none"}let ac;function actA(){if(!ac)ac=new(window.AudioContext||window.webkitAudioContext)();pA()}function silenciar(e){e.dataset.s="1";e.style.animation="none";e.style.background="#450a0a"}function pA(){let r=Array.from(document.querySelectorAll('.vence-rojo')).filter(e=>e.dataset.s!=="1");if(r.length>0&&ac){let o=ac.createOscillator(),g=ac.createGain();o.type='square';o.frequency.setValueAtTime(440,ac.currentTime);g.gain.setValueAtTime(0.1,ac.currentTime);o.connect(g);g.connect(ac.destination);o.start();o.stop(ac.currentTime+0.5);setTimeout(pA,2000)}}window.onload=()=>setTimeout(pA,1e3);</script></body></html>`)}catch(e){res.send(e.message)}});
app.post('/add',async(req,res)=>{req.body.f_act=getNow();await C.create(req.body);res.redirect('/')});
app.get('/d/:id',async(req,res)=>{await C.destroy({where:{id:req.params.id}});res.redirect('/')});
app.post('/u/:id',async(req,res)=>{await C.update({placa:req.body.placa.toUpperCase(),est_real:'DESPACHADO',f_act:getNow()},{where:{id:req.params.id}});res.redirect('/')});
app.post('/s/:id',async(req,res)=>{await C.update({obs_e:req.body.obs_e,f_act:getNow()},{where:{id:req.params.id}});res.sendStatus(200)});
app.get('/f/:id',async(req,res)=>{const a=getNow();await C.update({f_fin:a,obs_e:'FINALIZADO',est_real:'FINALIZADO',f_act:a},{where:{id:req.params.id}});res.redirect('/')});
db.sync({alter:true}).then(()=>app.listen(process.env.PORT||3000));
